services:
  service-modules:
    build:
      context: ../
      dockerfile: services/modules/Dockerfile
    environment:
      HOST: 0.0.0.0
      PORT: 8001
      GRPC_PORT: 50051
      POSTGRES_SERVER: infra-postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: modules_user
      POSTGRES_PASSWORD: modules_password
      POSTGRES_DB: modules_db
      MODULES_DEFAULT_TTL: 30
    depends_on:
      infra-postgres:
        condition: service_healthy
    networks:
      - portfolio-network
    restart: unless-stopped

  service-upload:
    build:
      context: ../
      dockerfile: services/upload/Dockerfile
    environment:
      HOST: 0.0.0.0
      PORT: 8003
      GRPC_PORT: 50054
      MINIO_ENDPOINT: infra-minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
      MINIO_BUCKET: uploads
      MINIO_SECURE: "false"
      MINIO_REGION: ""
      MINIO_EXTERNAL_URL: http://localhost:9000
    depends_on:
      infra-minio:
        condition: service_started
    networks:
      - portfolio-network
    restart: unless-stopped

  service-admin:
    build:
      context: ../
      dockerfile: services/admin/Dockerfile
    environment:
      HOST: 0.0.0.0
      PORT: 8004
      GRPC_PORT: 50053
      REDPANDA_BROKERS: infra-redpanda:19092
      UPLOAD_SERVICE_GRPC_HOST: service-upload
      UPLOAD_SERVICE_GRPC_PORT: 50054
      MODULES_GRPC_HOST: service-modules
      MODULES_GRPC_PORT: 50051
      MONGODB_URI: mongodb://admin:admin@infra-mongodb:27017
      MONGODB_DATABASE: admin_logs
      ADMIN_RESPONSE_TOPIC: admin_responses
      REQUEST_TIMEOUT: 30
    depends_on:
      infra-redpanda:
        condition: service_healthy
      service-modules:
        condition: service_started
      service-upload:
        condition: service_started
      infra-mongodb:
        condition: service_healthy
    networks:
      - portfolio-network
    restart: unless-stopped

  service-connections:
    build:
      context: ../
      dockerfile: services/connections/Dockerfile
    environment:
      POSTGRES_SERVER: infra-postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: connections_user
      POSTGRES_PASSWORD: connections_password
      POSTGRES_DB: connections_db
      MESSAGE_BROKERS: infra-redpanda:19092
      ADMIN_CONNECTIONS_TOPIC: admin_connections
      ADMIN_RESPONSE_TOPIC: admin_responses
      MODULES_SERVICE_URL: service-modules:50051
      GRPC_PORT: 50052
      HOST: 0.0.0.0
      PORT: 8002
      VERSION: "1.0.0"
      API_V1_STR: "/api/v1"
    depends_on:
      infra-postgres:
        condition: service_healthy
      infra-redpanda:
        condition: service_healthy
      service-modules:
        condition: service_started
      service-upload:
        condition: service_started
    networks:
      - portfolio-network
    restart: unless-stopped

  service-gateway:
    build:
      context: ../
      dockerfile: services/gateway/Dockerfile
    ports:
      - "8000:8000"
    environment:
      VERSION: "1.0.0"
      API_V1_STR: "/api/v1"
      CONNECTIONS_SERVICE_HOST: service-connections
      CONNECTIONS_SERVICE_PORT: 50052
      MODULES_SERVICE_HOST: service-modules
      MODULES_SERVICE_PORT: 50051
      MODULES_HTTP_PORT: 8001
      ADMIN_SERVICE_HOST: service-admin
      ADMIN_SERVICE_PORT: 50053
      ADMIN_HTTP_PORT: 8004
      REDIS_HOST: infra-redis
      REDIS_PORT: 6379
      REDIS_DB: 0
      REDIS_PASSWORD: ""
      GRPC_TIMEOUT: 30
      GRPC_MAX_RETRIES: 3
      CACHE_TTL_DEFAULT: 300
      CACHE_TTL_CONNECTIONS: 300
      CACHE_TTL_MODULES: 600
      CACHE_TTL_ADMIN: 60
      HOST: 0.0.0.0
      PORT: 8000
      LOG_LEVEL: INFO
      UPLOAD_SERVICE_HOST: service-upload
      UPLOAD_SERVICE_PORT: 8003
    depends_on:
      service-connections:
        condition: service_started
      infra-redis:
        condition: service_healthy
      service-modules:
        condition: service_started
      service-upload:
        condition: service_started
      service-admin:
        condition: service_started
    networks:
      - portfolio-network
    restart: unless-stopped
