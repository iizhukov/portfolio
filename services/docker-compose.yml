x-python-base-image: &python-base-image portfolio-python-base:latest

services:
  service-modules:
    build:
      context: ${COMPOSE_PROJECT_DIR:-.}/services/modules
      args:
        PYTHON_BASE_IMAGE: *python-base-image
    env_file:
      - ${COMPOSE_PROJECT_DIR:-.}/.env
    environment:
      HOST: 0.0.0.0
      PORT: 8001
      GRPC_PORT: 50051
      POSTGRES_SERVER: infra-postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_MODULES_USER:-modules_user}
      POSTGRES_PASSWORD: ${POSTGRES_MODULES_PASSWORD:-modules_password}
      POSTGRES_DB: ${POSTGRES_MODULES_DB:-modules_db}
      MODULES_DEFAULT_TTL: 30
    depends_on:
      infra-postgres:
        condition: service_healthy
    networks:
      - portfolio-network
    restart: unless-stopped

  service-upload:
    build:
      context: ${COMPOSE_PROJECT_DIR:-.}/services/upload
      args:
        PYTHON_BASE_IMAGE: *python-base-image
    env_file:
      - ${COMPOSE_PROJECT_DIR:-.}/.env
    environment:
      HOST: 0.0.0.0
      PORT: 8003
      GRPC_PORT: 50054
      MINIO_ENDPOINT: infra-minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin}
      MINIO_BUCKET: uploads
      MINIO_SECURE: "false"
      MINIO_REGION: ""
      MINIO_EXTERNAL_URL: http://localhost:9000
    depends_on:
      infra-minio:
        condition: service_started
    networks:
      - portfolio-network
    restart: unless-stopped

  service-admin:
    build:
      context: ${COMPOSE_PROJECT_DIR:-.}/services/admin
      args:
        PYTHON_BASE_IMAGE: *python-base-image
    env_file:
      - ${COMPOSE_PROJECT_DIR:-.}/.env
    environment:
      HOST: 0.0.0.0
      PORT: 8004
      GRPC_PORT: 50053
      REDPANDA_BROKERS: infra-redpanda:19092
      UPLOAD_SERVICE_GRPC_HOST: service-upload
      UPLOAD_SERVICE_GRPC_PORT: 50054
      MODULES_GRPC_HOST: service-modules
      MODULES_GRPC_PORT: 50051
      MONGODB_URI: mongodb://${MONGO_ROOT_USERNAME:-admin}:${MONGO_ROOT_PASSWORD:-admin}@infra-mongodb:27017
      MONGODB_DATABASE: admin_logs
      ADMIN_RESPONSE_TOPIC: admin_responses
      REQUEST_TIMEOUT: 30
    depends_on:
      infra-redpanda:
        condition: service_healthy
      service-modules:
        condition: service_started
      service-upload:
        condition: service_started
      infra-mongodb:
        condition: service_healthy
    networks:
      - portfolio-network
    restart: unless-stopped

  service-connections:
    build:
      context: ${COMPOSE_PROJECT_DIR:-.}/services/connections
      args:
        PYTHON_BASE_IMAGE: *python-base-image
    env_file:
      - ${COMPOSE_PROJECT_DIR:-.}/.env
    environment:
      POSTGRES_SERVER: infra-postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_CONNECTIONS_USER:-connections_user}
      POSTGRES_PASSWORD: ${POSTGRES_CONNECTIONS_PASSWORD:-connections_password}
      POSTGRES_DB: ${POSTGRES_CONNECTIONS_DB:-connections_db}
      MESSAGE_BROKERS: infra-redpanda:19092
      ADMIN_CONNECTIONS_TOPIC: admin_connections
      ADMIN_RESPONSE_TOPIC: admin_responses
      MODULES_SERVICE_URL: service-modules:50051
      GRPC_PORT: 50052
      HOST: 0.0.0.0
      PORT: 8002
      VERSION: "1.0.0"
      API_V1_STR: "/api/v1"
    depends_on:
      infra-postgres:
        condition: service_healthy
      infra-redpanda:
        condition: service_healthy
      service-modules:
        condition: service_started
      service-upload:
        condition: service_started
    networks:
      - portfolio-network
    restart: unless-stopped

  service-projects:
    build:
      context: ${COMPOSE_PROJECT_DIR:-.}/services/projects
      args:
        PYTHON_BASE_IMAGE: *python-base-image
    env_file:
      - ${COMPOSE_PROJECT_DIR:-.}/.env
    environment:
      POSTGRES_SERVER: infra-postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_PROJECTS_USER:-projects_user}
      POSTGRES_PASSWORD: ${POSTGRES_PROJECTS_PASSWORD:-projects_password}
      POSTGRES_DB: ${POSTGRES_PROJECTS_DB:-projects_db}
      MESSAGE_BROKERS: infra-redpanda:19092
      ADMIN_PROJECTS_TOPIC: admin_projects
      ADMIN_RESPONSE_TOPIC: admin_responses
      MODULES_SERVICE_URL: service-modules:50051
      GRPC_PORT: 50054
      HOST: 0.0.0.0
      PORT: 8004
      VERSION: "1.0.0"
      API_V1_STR: "/api/v1"
    depends_on:
      infra-postgres:
        condition: service_healthy
      infra-redpanda:
        condition: service_healthy
      service-modules:
        condition: service_started
    networks:
      - portfolio-network
    restart: unless-stopped

  service-gateway:
    build:
      context: ${COMPOSE_PROJECT_DIR:-.}/services/gateway
      args:
        PYTHON_BASE_IMAGE: *python-base-image
    ports:
      - "8000:8000"
    env_file:
      - ${COMPOSE_PROJECT_DIR:-.}/.env
    environment:
      VERSION: "1.0.0"
      API_V1_STR: "/api/v1"
      CONNECTIONS_SERVICE_HOST: service-connections
      CONNECTIONS_SERVICE_PORT: 50052
      PROJECTS_SERVICE_HOST: service-projects
      PROJECTS_SERVICE_PORT: 50054
      MODULES_SERVICE_HOST: service-modules
      MODULES_SERVICE_PORT: 50051
      MODULES_HTTP_PORT: 8001
      ADMIN_SERVICE_HOST: service-admin
      ADMIN_SERVICE_PORT: 50053
      ADMIN_HTTP_PORT: 8004
      REDIS_HOST: infra-redis
      REDIS_PORT: 6379
      REDIS_DB: 0
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      GRPC_TIMEOUT: 30
      GRPC_MAX_RETRIES: 3
      CACHE_TTL_DEFAULT: 300
      CACHE_TTL_CONNECTIONS: 300
      CACHE_TTL_MODULES: 600
      CACHE_TTL_ADMIN: 60
      HOST: 0.0.0.0
      PORT: 8000
      LOG_LEVEL: INFO
      UPLOAD_SERVICE_HOST: service-upload
      UPLOAD_SERVICE_PORT: 8003
      ADMIN_TOKEN_FILE: /shared/admin/token
    depends_on:
      service-connections:
        condition: service_started
      service-projects:
        condition: service_started
      infra-redis:
        condition: service_healthy
      service-modules:
        condition: service_started
      service-upload:
        condition: service_started
      service-admin:
        condition: service_started
    networks:
      - portfolio-network
    restart: unless-stopped
    volumes:
      - admin-token:/shared/admin
