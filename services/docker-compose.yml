services:
  modules-service:
    build:
      context: ../
      dockerfile: services/modules/Dockerfile
    environment:
      HOST: 0.0.0.0
      PORT: 8001
      GRPC_PORT: 50051
      POSTGRES_SERVER: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: modules_user
      POSTGRES_PASSWORD: modules_password
      POSTGRES_DB: modules_db
      MODULES_DEFAULT_TTL: 30
    ports:
      - "50051:50051"
      - "8001:8001"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - portfolio-network
    restart: unless-stopped

  upload-service:
    build:
      context: ../
      dockerfile: services/upload/Dockerfile
    environment:
      HOST: 0.0.0.0
      PORT: 8003
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
      MINIO_BUCKET: uploads
      MINIO_SECURE: "false"
      MINIO_REGION: ""
      MINIO_EXTERNAL_URL: http://localhost:9000
    ports:
      - "8003:8003"
    depends_on:
      minio:
        condition: service_started
    networks:
      - portfolio-network
    restart: unless-stopped

  admin-service:
    build:
      context: ../
      dockerfile: services/admin/Dockerfile
    environment:
      HOST: 0.0.0.0
      PORT: 8004
      GRPC_PORT: 50053
      REDPANDA_BROKERS: redpanda:19092
      UPLOAD_SERVICE_URL: http://upload-service:8003/api/v1/upload
      MODULES_GRPC_HOST: modules-service
      MODULES_GRPC_PORT: 50051
      MONGODB_URI: mongodb://admin:admin@mongodb:27017
      MONGODB_DATABASE: admin_logs
      ADMIN_RESPONSE_TOPIC: admin_responses
      REQUEST_TIMEOUT: 30
    ports:
      - "8004:8004"
      - "50053:50053"
    depends_on:
      redpanda:
        condition: service_healthy
      modules-service:
        condition: service_started
      upload-service:
        condition: service_started
      mongodb:
        condition: service_healthy
    networks:
      - portfolio-network
    restart: unless-stopped

  connections-service:
    build:
      context: ../
      dockerfile: services/connections/Dockerfile
    ports:
      - "8002:8002"
      - "50052:50052"
    environment:
      POSTGRES_SERVER: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: connections_user
      POSTGRES_PASSWORD: connections_password
      POSTGRES_DB: connections_db
      MESSAGE_BROKERS: redpanda:19092
      ADMIN_CONNECTIONS_TOPIC: admin_connections
      ADMIN_RESPONSE_TOPIC: admin_responses
      MODULES_SERVICE_URL: modules-service:50051
      GRPC_PORT: 50052
      HOST: 0.0.0.0
      PORT: 8002
      VERSION: "1.0.0"
      API_V1_STR: "/api/v1"
    depends_on:
      postgres:
        condition: service_healthy
      redpanda:
        condition: service_healthy
      modules-service:
        condition: service_started
      upload-service:
        condition: service_started
    networks:
      - portfolio-network
    restart: unless-stopped

  api-gateway:
    build:
      context: ../
      dockerfile: services/gateway/Dockerfile
    ports:
      - "8000:8000"
    environment:
      VERSION: "1.0.0"
      API_V1_STR: "/api/v1"
      CONNECTIONS_SERVICE_HOST: connections-service
      CONNECTIONS_SERVICE_PORT: 50052
      MODULES_SERVICE_HOST: modules-service
      MODULES_SERVICE_PORT: 50051
      MODULES_HTTP_PORT: 8001
      ADMIN_SERVICE_HOST: admin-service
      ADMIN_SERVICE_PORT: 50053
      ADMIN_HTTP_PORT: 8004
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_DB: 0
      REDIS_PASSWORD: ""
      GRPC_TIMEOUT: 30
      GRPC_MAX_RETRIES: 3
      CACHE_TTL_DEFAULT: 300
      CACHE_TTL_CONNECTIONS: 300
      CACHE_TTL_MODULES: 600
      CACHE_TTL_ADMIN: 60
      HOST: 0.0.0.0
      PORT: 8000
      LOG_LEVEL: INFO
      UPLOAD_SERVICE_HOST: upload-service
      UPLOAD_SERVICE_PORT: 8003
    depends_on:
      connections-service:
        condition: service_started
      redis:
        condition: service_healthy
      modules-service:
        condition: service_started
      upload-service:
        condition: service_started
      admin-service:
        condition: service_started
    networks:
      - portfolio-network
    restart: unless-stopped
